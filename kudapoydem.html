<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö—É–¥–∞–ü–æ–π–¥—ë–º</title>
    <script type="text/javascript" src="https://gc.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=TLITUQGu1liJ45bz-K7CVKC13kcWBphKNc4C9kVoHRtqyKL3mPhWVv2CrdO5rkMQfuScAtmVbm7_1UgXMTBayKvfsDrAX4zjxQaAqb7r5NKJp5zW16vjYV0C36D4sncPzVUMzZD9mCYpb2s8ouAJ8KxHuxsAbs1AQ6YveuJtgtukhg3Ylltiz7nE6-IWjzlyuCnMMhsXH-b7ubaEtFZeZE9ng5R6SPu14cHvXFjB-5nkbU9LGlUk2HzaxKiQ60E1jwyoUIOT11Qtqpyx9QokyA_5bpjxCjZ5aD4DXR7VjQpFVXqXcSd7RbFAhvrro7f20fwj8i5nDQvGON-uEys10pJOiqEEWAFgmOU-SXCa6d3zkal96GCBNgm7lYykCDgZ4ieqKy8WZ-xIscCAc4hERPm7P23z4z5td_SBi3B7vOYJS9xwzU4ge0dD5_9SGV2aUbRj9zoTBDpYf5ker9N_Z5g4_s0tNUIeypOYJssuOm7QHdO45b9Ezp4-6I0hU8w0MQ4_DdjprTdoTB4gRrjseHYeGecK4WGgOlT5XrTaN5BKV6LwCWgT5nui1YGshmHGCeXJ6Wzuj-WvihVZrXM_8A4lk3fVNr3sM8YgzApyAuzJ5kvkyNxlk14LDa8-d3XAvgVLz3U5CgkvZb2BTZrxGY2n9a38onFsrJF1dWGfNco6B7TVAwBbWJDrOkUOBmDFcMD1b1H0swbLUJSOF2nPuiUaLeQcnND-cAHyQPmm18nM2Muc_rP5zrGr3YkI2ka2EtjWs-099Su7T_aR6n5ZVeUMElHpnVePUO7CcTb5dfGvXwKGbsz8YhQYF0rE5wB-q8XEK7tzC7nkDywsByA7awrpWxg9LXEI55CcbtSj5S3IW6YrN7gHxvB6-blyxXLk5Awij8AThS3pbNbKgB3RKllobptYJyZuu8uApV5M3ojs0enXU3C348fgPCKekMNXMZdEgJSxZzTNa65mKA-iWiQH-H-0A9QwdxDB7XzV0iFEDx1YgieDwwV1KV8YrgvCbc4jT-N0VbGyOFthessNt-CxK9pWm_B4gddOer3rHKwBa0RkdLMhazp4Q1m1hs3vdUyAHKquq9led4Nc2e31A03DimJcl_4xPLDmiPtv-cOUnMhDCs82ETZYRWYtBxUQu_zYwpKLBFF1gCRqO1QED4FWIHdT3JH15LvymtDG2VGnf02_bKDz3t131_vnb-qQh5-sAEo_StxfbPxp5dHDfZVTslLXRC-YH9ZbEtSvyuyPZwV6_jvSUzygMunhOu2Rm8CBWKDn8Q03E7fum-zoNgdqmR6HKyGSl68LdIjr5ldrhY3VtMo12H4goo0lyx3b8dhrFP-fgrBYO5RdeHwxMszpdmODA0QXXL8FFzMaB2mFvM3vZ9vUUFT4UDnh_LySeEFwspiKLytlTkdHOqPU6h_rwAEVbcaKr3_Um0p_MAu2ceM3npFlDu9MWiaVl1izbLFLYZ0EwpjenADSrDWkX7ToIpOg42LA5bobgSqWFubmZ_tMIP1Ux5x_eWCEoktHrEnxkUh-miOLDDTA19YXpx-Dwb584HFKjER6jygH5Y8sJaYiCIMqE9Qlxxhfl6kEoTq7Af_tTW8AHoSshpdeUWJrCZF-yRlWrUNlRG1kkFXQXbZuGsrq1jdetZ1WTvx1HPVod_vwrwm8MgYycleD2XI_ZqeA-wpXYXdKKCb3uogyTB8clVVVLIUbCj6e8NNs7Gz2wiF0LynaInalUAPmNSu-WwFMW4ZREb0eVYgnVL3Ig1NnSY41JBtodiGqMq1QaOsVKma6D75UAFBreV3qJ2AG1aOWAhGyzrAKVutmZkFnPYTQv0PGk1Bn92BH0djLbrFQSubwVSzqr2tRF4WzsQIDEGh4yORSgGEUGezD8QRqF0TmJK9aPrE9ONrXqlYMbNSFbRUJyO7_DtYclctm9qEfs9ZzripRUapO1v0j_gnQT1JPOX6woseW9M-fJv6Ddi8F55bRZJ9ODtTnlrpW9DWlATzVfLv2oExXMZVolpsbyD4VE-GDxS9e9BdKKnyEYGZoTRlSlY6FBDd3mF7AKBnMBiIdWyG7iyqp5kXuaQC8isvRaxqhI1P4ou0H8MJ_7Cu46pVgnHu4yGBvDqHh35wx_WdRo9C8cr-_kuQuZLFSWBtyzf6dAaSaJfslCx-MgLZyM8vjP7nnYQiP3Zpx16McRiAgzGi0AeBB063e3Xk5SAqRQa2FIOCtvAekcAwu" charset="UTF-8"></script><script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: #2181CE;
            --primary-hover: #1A6BB8;
            --bg: #f5f5f5;
            --surface: #ffffff;
            --text: #1a1a1a;
            --text-secondary: #666;
            --border: #e0e0e0;
            --success: #31c27e;
            --error: #ff4444;
            --warning: #ffa500;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
        }

        .app {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .screen {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding: 0;
            animation: fadeIn 0.2s ease-in;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Top Bar */
        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            min-height: 50px;
        }

        .top-bar__back {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            color: var(--primary);
        }

        .top-bar__title {
            flex: 1;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
        }

        .top-bar__spacer {
            width: 32px;
        }

        /* Content Area */
        .screen__content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow-y: auto;
        }

        .container {
            padding: 16px;
            flex: 1;
        }

        /* Buttons */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            gap: 8px;
        }

        .btn--primary {
            background: var(--primary);
            color: #fff;
            width: 100%;
        }

        .btn--primary:active {
            background: var(--primary-hover);
            transform: scale(0.98);
        }

        .btn--secondary {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
            width: 100%;
        }

        .btn--secondary:active {
            background: var(--border);
        }

        .btn--small {
            padding: 8px 12px;
            font-size: 14px;
            width: auto;
        }

        .btn--text {
            background: none;
            color: var(--primary);
            padding: 8px;
            font-size: 14px;
            text-decoration: underline;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Bottom Button Area */
        .screen__footer {
            padding: 16px;
            background: var(--surface);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            flex-direction: column;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            background: var(--surface);
            color: var(--text);
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(33, 129, 206, 0.1);
        }

        .form-error {
            color: var(--error);
            font-size: 12px;
            margin-top: 4px;
        }

        /* Cards */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .card__title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .card__subtitle {
            color: var(--text-secondary);
            font-size: 12px;
        }

        /* Goal Cards */
        .goal-card {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 12px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 8px;
        }

        .goal-card.active {
            border-color: var(--primary);
            background: rgba(33, 129, 206, 0.05);
        }

        /* Chips */
        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .chip {
            padding: 8px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chip.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        /* Toggle */
        .toggle {
            display: flex;
            background: var(--bg);
            border-radius: 6px;
            padding: 4px;
            gap: 4px;
        }

        .toggle__option {
            flex: 1;
            padding: 8px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 4px;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .toggle__option.active {
            background: var(--surface);
            color: var(--primary);
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--bg);
            border-radius: 2px;
            overflow: hidden;
            margin: 12px 0;
        }

        .progress-bar__fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text);
            color: #fff;
            padding: 12px 16px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 14px;
            max-width: 90%;
            text-align: center;
            animation: slideUp 0.2s ease;
        }

        .toast.error {
            background: var(--error);
        }

        .toast.success {
            background: var(--success);
        }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: flex-end;
            z-index: 999;
        }

        .modal.active {
            display: flex;
        }

        .modal__content {
            background: var(--surface);
            border-radius: 16px 16px 0 0;
            width: 100%;
            padding: 20px;
            animation: slideUpModal 0.3s ease;
        }

        @keyframes slideUpModal {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal__close {
            text-align: center;
            color: var(--text-secondary);
            font-size: 12px;
            margin-top: 16px;
        }

        /* Map Placeholder */
        .map-placeholder {
            width: 100%;
            height: 180px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 600;
            margin-bottom: 16px;
        }

        /* Summary Block */
        .summary {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
            background: var(--bg);
            padding: 12px;
            border-radius: 8px;
        }

        .summary__item {
            text-align: center;
        }

        .summary__label {
            color: var(--text-secondary);
            font-size: 11px;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .summary__value {
            font-weight: 600;
            font-size: 14px;
        }

        /* Points List */
        .points-list {
            margin-bottom: 16px;
        }

        .point-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .point-item:active {
            background: var(--bg);
        }

        .point-item__header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .point-item__title {
            font-weight: 600;
            font-size: 14px;
            flex: 1;
        }

        .point-item__time {
            color: var(--text-secondary);
            font-size: 12px;
            white-space: nowrap;
        }

        .point-item__description {
            color: var(--text-secondary);
            font-size: 12px;
            margin-bottom: 8px;
        }

        .point-item__tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .tag {
            background: var(--bg);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Tuners */
        .tuners {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tuner {
            padding: 8px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tuner.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        /* Onboarding */
        .onboarding {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px 16px;
        }

        .onboarding__logo {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .onboarding__title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .onboarding__subtitle {
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 14px;
        }

        /* Preset Buttons */
        .presets {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }

        .preset-btn {
            padding: 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            font-weight: 500;
        }

        .preset-btn.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        /* Step Progress */
        .step-header {
            background: var(--surface);
            padding: 16px;
            border-bottom: 1px solid var(--border);
            text-align: center;
        }

        .step-header__title {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .step-header__info {
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 16px;
            text-align: center;
            flex: 1;
        }

        .empty-state__icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state__text {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        /* Saved Routes */
        .saved-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .saved-item__info {
            flex: 1;
        }

        .saved-item__title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .saved-item__meta {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .saved-item__actions {
            display: flex;
            gap: 8px;
        }

        /* Icons */
        .icon {
            display: inline-block;
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- SCREEN 1: ONBOARDING -->
        <div class="screen active" id="screen-onboard">
            <div class="screen__content">
                <div class="container onboarding">
                    <div class="onboarding__logo">üö∂</div>
                    <h1 class="onboarding__title">–ö—É–¥–∞–ü–æ–π–¥—ë–º</h1>
                    <p class="onboarding__subtitle">–ò–¥–µ–∞–ª—å–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç –∑–∞ 1 –º–∏–Ω—É—Ç—É</p>
                    
                    <div style="width: 100%; text-align: left; margin-bottom: 24px;">
                        <div class="goal-card" onclick="app.selectGoal(0)">
                            <div>‚è±Ô∏è 2 —á–∞—Å–∞ –±–µ–∑ –æ—á–µ—Ä–µ–¥–µ–π</div>
                        </div>
                        <div class="goal-card" onclick="app.selectGoal(1)">
                            <div>‚ö° 30‚Äì60 –º–∏–Ω –º–µ–∂–¥—É –ø–∞—Ä–∞–º–∏</div>
                        </div>
                        <div class="goal-card" onclick="app.selectGoal(2)">
                            <div>üèòÔ∏è –û—Å–≤–æ–∏—Ç—å —Ä–∞–π–æ–Ω</div>
                        </div>
                    </div>

                    <div class="form-group" style="width: 100%;">
                        <div class="form-label">–†–µ–∂–∏–º</div>
                        <div class="toggle">
                            <button class="toggle__option active" onclick="app.setMode('walk')">–ü—Ä–æ–≥—É–ª–∫–∞</button>
                            <button class="toggle__option" onclick="app.setMode('quest')">–ö–≤–µ—Å—Ç</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="screen__footer">
                <button class="btn btn--primary" onclick="app.goToCriteria()">–ù–∞—á–∞—Ç—å</button>
                <button class="btn btn--text" onclick="app.showHowWorks()">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</button>
            </div>
        </div>

        <!-- SCREEN 2: CRITERIA -->
        <div class="screen" id="screen-criteria">
            <div class="top-bar">
                <button class="top-bar__back" onclick="app.back()">‚Üê –ù–∞–∑–∞–¥</button>
                <div class="top-bar__title">–ö—Ä–∏—Ç–µ—Ä–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞</div>
                <div class="top-bar__spacer"></div>
            </div>
            <div class="screen__content">
                <div class="container">
                    <div class="form-group">
                        <div class="form-label">–ü—Ä–µ—Å–µ—Ç—ã</div>
                        <div class="presets">
                            <button class="preset-btn" onclick="app.applyPreset('tourist')">–¢—É—Ä–∏—Å—Ç</button>
                            <button class="preset-btn" onclick="app.applyPreset('student')">–°—Ç—É–¥–µ–Ω—Ç</button>
                            <button class="preset-btn" onclick="app.applyPreset('newcomer')">–ü–µ—Ä–µ—Å–µ–ª–µ–Ω–µ—Ü</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-label">–õ–æ–∫–∞—Ü–∏—è</div>
                        <button class="btn btn--secondary btn--small" style="width: 100%; margin-bottom: 8px;" onclick="app.requestGeo()">üìç –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ—é –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é</button>
                        <input type="text" class="form-input" id="city-input" placeholder="–ì–æ—Ä–æ–¥ –∏–ª–∏ —Ä–∞–π–æ–Ω" value="">
                        <div class="form-error" id="city-error"></div>
                    </div>

                    <div class="form-group">
                        <div class="form-label">–í—Ä–µ–º—è (–º–∏–Ω—É—Ç)</div>
                        <div class="chips">
                            <div class="chip" onclick="app.setTime(45)">30‚Äì60</div>
                            <div class="chip" onclick="app.setTime(105)">90‚Äì120</div>
                            <div class="chip" onclick="app.setTime(150)">120‚Äì180</div>
                            <div class="chip" onclick="app.setTime(null)">–ö–∞—Å—Ç–æ–º</div>
                        </div>
                        <input type="number" class="form-input" id="time-custom" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω—É—Ç" style="display: none;" min="10" max="480">
                        <div class="form-error" id="time-error"></div>
                    </div>

                    <div class="form-group">
                        <div class="form-label">–ë—é–¥–∂–µ—Ç</div>
                        <select class="form-select" id="budget">
                            <option value="free">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</option>
                            <option value="budget">–î–æ 500 —Ä.</option>
                            <option value="moderate">–î–æ 2000 —Ä.</option>
                            <option value="any">–ù–µ –≤–∞–∂–Ω–æ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <div class="form-label">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</div>
                        <div class="chips" id="mood-chips">
                            <div class="chip" onclick="app.toggleMood(this, 'relax')">üßò –†–µ–ª–∞–∫—Å</div>
                            <div class="chip" onclick="app.toggleMood(this, 'active')">üèÉ –ê–∫—Ç–∏–≤–Ω–æ</div>
                            <div class="chip" onclick="app.toggleMood(this, 'cultural')">üé® –ö—É–ª—å—Ç—É—Ä–∞</div>
                            <div class="chip" onclick="app.toggleMood(this, 'food')">üçΩÔ∏è –ï–¥–∞</div>
                            <div class="chip" onclick="app.toggleMood(this, 'photo')">üì∏ –§–æ—Ç–æ</div>
                            <div class="chip" onclick="app.toggleMood(this, 'shop')">üõçÔ∏è –®–æ–ø–∏–Ω–≥</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-label">–ö–æ–º–ø–∞–Ω–∏—è</div>
                        <select class="form-select" id="company">
                            <option value="alone">–û–¥–∏–Ω</option>
                            <option value="couple">–ü–∞—Ä–∞</option>
                            <option value="friends">–î—Ä—É–∑—å—è</option>
                            <option value="family">–°–µ–º—å—è</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="no-queue" style="width: 18px; height: 18px;">
                            <span>–ë–µ–∑ –æ—á–µ—Ä–µ–¥–µ–π</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="screen__footer">
                <button class="btn btn--primary" onclick="app.generateRoute()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>

        <!-- SCREEN 3: GENERATING -->
        <div class="screen" id="screen-generating">
            <div class="screen__content">
                <div class="container" style="display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
                    <div class="spinner"></div>
                    <p style="margin-top: 24px; font-weight: 600;">–ö—É–¥–∞–ü–æ–π–¥—ë–º –ø–æ–¥–±–∏—Ä–∞–µ—Ç —Ç–æ—á–∫–∏‚Ä¶</p>
                    <p style="color: var(--text-secondary); font-size: 13px; margin-top: 8px;" id="gen-tip">‚ú® –°–æ–≤–µ—Ç: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</p>
                    <div class="progress-bar" style="margin-top: 32px; width: 80%;">
                        <div class="progress-bar__fill" style="width: 0%;" id="gen-progress"></div>
                    </div>
                </div>
            </div>
            <div class="screen__footer">
                <button class="btn btn--secondary" onclick="app.cancelGenerate()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>

        <!-- SCREEN 4: PREVIEW -->
        <div class="screen" id="screen-preview">
            <div class="top-bar">
                <button class="top-bar__back" onclick="app.back()">‚Üê –ù–∞–∑–∞–¥</button>
                <div class="top-bar__title">–ú–∞—Ä—à—Ä—É—Ç</div>
                <div class="top-bar__spacer"></div>
            </div>
            <div class="screen__content">
                <div class="container">
                    <h2 id="preview-title" style="margin-bottom: 4px;">–ú–∞—Ä—à—Ä—É—Ç –æ—Ç –ö—É–¥–∞–ü–æ–π–¥—ë–º</h2>
                    <p id="preview-subtitle" style="color: var(--text-secondary); margin-bottom: 16px;">–≥–æ—Ä–æ–¥, 1 —á–∞—Å</p>
                    
                    <div class="map-placeholder">üó∫Ô∏è –ö–∞—Ä—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞</div>

                    <div class="summary">
                        <div class="summary__item">
                            <div class="summary__label">–í—Ä–µ–º—è</div>
                            <div class="summary__value" id="preview-time">90 –º–∏–Ω</div>
                        </div>
                        <div class="summary__item">
                            <div class="summary__label">–ü–µ—à–∫–æ–º</div>
                            <div class="summary__value" id="preview-distance">2.5 –∫–º</div>
                        </div>
                        <div class="summary__item">
                            <div class="summary__label">–ë—é–¥–∂–µ—Ç</div>
                            <div class="summary__value" id="preview-cost">~500 ‚ÇΩ</div>
                        </div>
                    </div>

                    <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">–¢—é–Ω–µ—Ä—ã</h3>
                    <div class="tuners">
                        <button class="tuner" onclick="app.applyTuner('walk')">üö∂ –ú–µ–Ω—å—à–µ —Ö–æ–¥—å–±—ã</button>
                        <button class="tuner" onclick="app.applyTuner('cheap')">üí∞ –î–µ—à–µ–≤–ª–µ</button>
                        <button class="tuner" onclick="app.applyTuner('local')">üèòÔ∏è –õ–æ–∫–∞–ª—å–Ω–æ–µ</button>
                    </div>

                    <h3 style="font-size: 14px; font-weight: 600; margin: 16px 0 8px 0;">–¢–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞</h3>
                    <div class="points-list" id="preview-points"></div>
                </div>
            </div>
            <div class="screen__footer">
                <button class="btn btn--primary" onclick="app.startRoute()">üöÄ –°—Ç–∞—Ä—Ç –º–∞—Ä—à—Ä—É—Ç–∞</button>
                <button class="btn btn--secondary" onclick="app.toggleMode()">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º</button>
                <button class="btn btn--text" onclick="app.saveRoute()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn btn--text" onclick="app.shareRoute()">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
            </div>
        </div>

        <!-- SCREEN 5: STEP (Point) -->
        <div class="screen" id="screen-step">
            <div class="step-header">
                <div class="step-header__title" id="step-title">–¢–æ—á–∫–∞ 1 / 5</div>
                <div class="progress-bar">
                    <div class="progress-bar__fill" style="width: 20%;" id="step-progress"></div>
                </div>
                <div class="step-header__info" id="step-info">–û—Ç–∫—Ä–æ–π—Ç–µ –¥–ª—è —Å–µ–±—è –Ω–æ–≤–æ–µ –º–µ—Å—Ç–æ</div>
            </div>
            <div class="screen__content">
                <div class="container">
                    <div class="card">
                        <div class="card__title" id="step-name">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏</div>
                        <div class="card__subtitle" id="step-description">–û–ø–∏—Å–∞–Ω–∏–µ</div>
                        <div style="margin-top: 12px; color: var(--text-secondary); font-size: 12px;" id="step-time">‚è±Ô∏è 20 –º–∏–Ω—É—Ç –Ω–∞ –º–µ—Å—Ç–µ</div>
                    </div>

                    <div id="quest-block" style="display: none;">
                        <div class="card">
                            <div class="card__title">üìù –ó–∞–¥–∞–Ω–∏–µ</div>
                            <div class="card__subtitle" id="quest-text">–ù–∞–π–¥–∏—Ç–µ —Ñ–æ–Ω—Ç–∞–Ω –∏ —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ</div>
                            <button class="btn btn--text" onclick="app.showQuestHint()" style="margin-top: 8px;">–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É</button>
                            <div id="quest-hint" style="margin-top: 8px; padding: 8px; background: var(--bg); border-radius: 6px; font-size: 12px; color: var(--text-secondary); display: none;"></div>
                        </div>
                    </div>

                    <button class="btn btn--secondary" style="margin: 16px 0;" onclick="app.navigate()">üó∫Ô∏è –ù–∞–≤–∏–≥–∏—Ä–æ–≤–∞—Ç—å</button>

                    <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">–ß–µ–∫-–∏–Ω</h3>
                </div>
            </div>
            <div class="screen__footer">
                <button class="btn btn--primary" onclick="app.checkInGeo()">‚úÖ –Ø –Ω–∞ –º–µ—Å—Ç–µ</button>
                <button class="btn btn--secondary" onclick="app.checkInQR()">üì± –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>
                <button class="btn btn--text" onclick="app.skipPoint()">‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
            </div>
        </div>

        <!-- SCREEN 6: FINISH -->
        <div class="screen" id="screen-finish">
            <div class="top-bar">
                <div class="top-bar__back" style="visibility: hidden;">‚Üê –ù–∞–∑–∞–¥</div>
                <div class="top-bar__title">–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ</div>
                <div class="top-bar__spacer"></div>
            </div>
            <div class="screen__content">
                <div class="container">
                    <h1 style="text-align: center; margin-bottom: 8px; margin-top: 24px;">üéâ –ì–æ—Ç–æ–≤–æ!</h1>
                    <p style="text-align: center; color: var(--text-secondary); margin-bottom: 24px;">–≠—Ç–æ –±—ã–ª –º–∞—Ä—à—Ä—É—Ç –æ—Ç –ö—É–¥–∞–ü–æ–π–¥—ë–º</p>

                    <div class="summary">
                        <div class="summary__item">
                            <div class="summary__label">–ü—Ä–æ–π–¥–µ–Ω–æ</div>
                            <div class="summary__value" id="finish-completed">5/5</div>
                        </div>
                        <div class="summary__item">
                            <div class="summary__label">–í—Ä–µ–º—è</div>
                            <div class="summary__value" id="finish-time">1 —á 45 –º</div>
                        </div>
                        <div class="summary__item">
                            <div class="summary__label">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ</div>
                            <div class="summary__value" id="finish-distance">3 –∫–º</div>
                        </div>
                    </div>

                    <h3 style="font-size: 14px; font-weight: 600; margin: 16px 0 8px 0;">–ü–æ—Å–µ—â—ë–Ω–Ω—ã–µ —Ç–æ—á–∫–∏</h3>
                    <div class="points-list" id="finish-points"></div>
                </div>
            </div>
            <div class="screen__footer">
                <button class="btn btn--primary" onclick="app.saveRoute()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
                <button class="btn btn--secondary" onclick="app.shareRoute()">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
                <button class="btn btn--text" onclick="app.createNew()">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π</button>
            </div>
        </div>

        <!-- SCREEN 7: SAVED ROUTES -->
        <div class="screen" id="screen-saved">
            <div class="top-bar">
                <button class="top-bar__back" onclick="app.back()">‚Üê –ù–∞–∑–∞–¥</button>
                <div class="top-bar__title">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ</div>
                <div class="top-bar__spacer"></div>
            </div>
            <div class="screen__content">
                <div class="container">
                    <div id="saved-list"></div>
                    <div id="saved-empty" class="empty-state">
                        <div class="empty-state__icon">üìå</div>
                        <p class="empty-state__text">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤</p>
                    </div>
                </div>
            </div>
            <div class="screen__footer">
                <button class="btn btn--primary" onclick="app.goToCriteria()">‚ûï –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
            </div>
        </div>
    </div>

    <script>
        // Telegram WebApp Initialization
        if (window.Telegram && window.Telegram.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        const app = {
            currentScreen: 'onboard',
            state: {
                mode: 'walk',
                goal: null,
                city: '',
                time: 60,
                budget: 'free',
                mood: [],
                company: 'alone',
                noQueue: true,
                preset: null,
                currentRoute: null,
                currentPointIndex: 0,
                completedPoints: [],
                savedRoutes: JSON.parse(localStorage.getItem('kudapoydem_saved') || '[]'),
            },

            log: (event, props = {}) => {
                console.log(`[Analytics] ${event}`, props);
            },

            showScreen: (screenId) => {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(`screen-${screenId}`).classList.add('active');
                app.currentScreen = screenId;
                app.log('screen_view', { screen: screenId });
            },

            toast: (message, type = 'info') => {
                const t = document.createElement('div');
                t.className = `toast ${type}`;
                t.textContent = message;
                document.body.appendChild(t);
                setTimeout(() => t.remove(), 3000);
            },

            back: () => {
                if (app.currentScreen === 'criteria') app.showScreen('onboard');
                else if (app.currentScreen === 'preview') app.showScreen('criteria');
                else if (app.currentScreen === 'step') app.showScreen('preview');
                else if (app.currentScreen === 'saved') app.showScreen('onboard');
            },

            // ONBOARDING
            selectGoal: (index) => {
                app.state.goal = index;
                document.querySelectorAll('#screen-onboard .goal-card').forEach((el, i) => {
                    el.classList.toggle('active', i === index);
                });
            },

            setMode: (mode) => {
                app.state.mode = mode;
                document.querySelectorAll('#screen-onboard .toggle__option').forEach(el => {
                    el.classList.toggle('active', el.textContent.includes(mode === 'walk' ? '–ü—Ä–æ–≥—É–ª–∫–∞' : '–ö–≤–µ—Å—Ç'));
                });
                app.log('onboard_mode_toggle', { mode });
            },

            showHowWorks: () => {
                app.toast('–≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–∞–∫: 1) –≤—ã –≤—ã–±–∏—Ä–∞–µ—Ç–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ 2) –ò–ò –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –º–∞—Ä—à—Ä—É—Ç 3) –≤—ã —Ö–æ–¥–∏—Ç–µ –∏ —á–µ–∫–∏–Ω–∏–º', 'info');
            },

            goToCriteria: () => {
                app.log('onboard_continue_click', { preset: app.state.preset });
                app.showScreen('criteria');
            },

            // CRITERIA
            requestGeo: () => {
                app.log('geo_request_click');
                if (!navigator.geolocation) {
                    app.toast('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        app.state.city = `${pos.coords.latitude.toFixed(2)}, ${pos.coords.longitude.toFixed(2)}`;
                        document.getElementById('city-input').value = '–í–∞—à–∞ –ª–æ–∫–∞—Ü–∏—è';
                        app.toast('–õ–æ–∫–∞—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞', 'success');
                    },
                    () => {
                        app.toast('–í–∫–ª—é—á–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏', 'error');
                    }
                );
            },

            applyPreset: (preset) => {
                app.state.preset = preset;
                const presets = {
                    tourist: { budget: 'moderate', noQueue: true, mood: ['photo', 'cultural'] },
                    student: { budget: 'free', noQueue: false, mood: ['active', 'food'] },
                    newcomer: { budget: 'budget', noQueue: false, mood: ['cultural', 'relax'] },
                };
                Object.assign(app.state, presets[preset]);
                document.querySelectorAll('.preset-btn').forEach((el, i) => {
                    el.classList.toggle('active', ['tourist', 'student', 'newcomer'][i] === preset);
                });
                app.log('preset_selected', { preset });
            },

            setTime: (minutes) => {
                if (minutes === null) {
                    document.getElementById('time-custom').style.display = 'block';
                    app.state.time = 0;
                } else {
                    document.getElementById('time-custom').style.display = 'none';
                    app.state.time = minutes;
                    document.querySelectorAll('#screen-criteria .chips .chip').forEach((el, i) => {
                        const times = [45, 105, 150];
                        el.classList.toggle('active', times[i] === minutes);
                    });
                }
            },

            toggleMood: (el, mood) => {
                if (app.state.mood.includes(mood)) {
                    app.state.mood = app.state.mood.filter(m => m !== mood);
                } else {
                    app.state.mood.push(mood);
                }
                el.classList.toggle('active');
            },

            generateRoute: () => {
                const city = document.getElementById('city-input').value;
                const timeVal = document.getElementById('time-custom').style.display === 'block' 
                    ? parseInt(document.getElementById('time-custom').value) 
                    : app.state.time;

                if (!city) {
                    document.getElementById('city-error').textContent = '–£–∫–∞–∂–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é';
                    return;
                }
                if (!timeVal) {
                    document.getElementById('time-error').textContent = '–£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è';
                    return;
                }

                app.state.city = city;
                app.state.time = timeVal;
                app.state.budget = document.getElementById('budget').value;
                app.state.company = document.getElementById('company').value;
                app.state.noQueue = document.getElementById('no-queue').checked;

                app.log('form_submit', {
                    preset: app.state.preset,
                    time_min: app.state.time,
                    budget: app.state.budget,
                    mood: app.state.mood,
                    company: app.state.company,
                    noQueue: app.state.noQueue,
                    mode: app.state.mode,
                });

                app.showScreen('generating');
                app.simulateGeneration();
            },

            cancelGenerate: () => {
                app.log('generate_cancel_click');
                app.showScreen('criteria');
            },

            simulateGeneration: () => {
                app.log('generate_start');
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 30;
                    if (progress > 95) progress = 95;
                    document.getElementById('gen-progress').style.width = progress + '%';
                    
                    const tips = ['‚ú® –°–æ–≤–µ—Ç: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ', 'üó∫Ô∏è –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç—É...', 'üèôÔ∏è –ò—â–µ–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –º–µ—Å—Ç–∞...'];
                    document.getElementById('gen-tip').textContent = tips[Math.floor(Math.random() * tips.length)];

                    if (progress >= 95) {
                        clearInterval(interval);
                        app.generateMockRoute();
                    }
                }, 300);
            },

            generateMockRoute: () => {
                app.state.currentRoute = {
                    id: `route_${Date.now()}`,
                    city: app.state.city,
                    mode: app.state.mode,
                    totalTime: app.state.time,
                    totalCost: Math.floor(Math.random() * 3000),
                    distance: (Math.random() * 5 + 1).toFixed(1),
                    points: [
                        { id: 1, name: 'üèõÔ∏è –ú—É–∑–µ–π', description: '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ –∑–¥–∞–Ω–∏–µ', time: 30, cost: 0, quest: '–ù–∞–π–¥–∏—Ç–µ –∫—Ä–∞—Å–∏–≤—ã–π —Ñ–∞—Å–∞–¥' },
                        { id: 2, name: '‚òï –ö–æ—Ñ–µ–π–Ω—è', description: '–£—é—Ç–Ω–æ–µ –º–µ—Å—Ç–æ', time: 20, cost: 200, quest: '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ñ–∏—Ä–º–µ–Ω–Ω—ã–π –∫–æ—Ñ–µ' },
                        { id: 3, name: 'üå≥ –ü–∞—Ä–∫', description: '–°–≤–µ–∂–∏–π –≤–æ–∑–¥—É—Ö', time: 25, cost: 0, quest: '–°–¥–µ–ª–∞–π—Ç–µ —Å–µ–ª—Ñ–∏ —É –¥–µ—Ä–µ–≤–∞' },
                        { id: 4, name: 'üé® –ì–∞–ª–µ—Ä–µ—è', description: '–°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∏—Å–∫—É—Å—Å—Ç–≤–æ', time: 20, cost: 0, quest: '–ù–∞–π–¥–∏—Ç–µ —Å–∞–º—É—é –∏–Ω—Ç–µ—Ä–µ—Å–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É' },
                        { id: 5, name: 'üçï –ü–∏—Ü—Ü–µ—Ä–∏—è', description: '–í–∫—É—Å–Ω–æ –∏ –Ω–µ–¥–æ—Ä–æ–≥–æ', time: 30, cost: 400, quest: '–ó–∞–∫–∞–∂–∏—Ç–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –±–ª—é–¥–æ' },
                    ],
                };
                app.log('generate_success', {
                    route_id: app.state.currentRoute.id,
                    poi_count: app.state.currentRoute.points.length,
                    total_time: app.state.currentRoute.totalTime,
                    total_cost: app.state.currentRoute.totalCost,
                });
                app.showScreen('preview');
                app.renderPreview();
            },

            // PREVIEW
            renderPreview: () => {
                const route = app.state.currentRoute;
                document.getElementById('preview-title').textContent = `–ú–∞—Ä—à—Ä—É—Ç –æ—Ç –ö—É–¥–∞–ü–æ–π–¥—ë–º`;
                document.getElementById('preview-subtitle').textContent = `${route.city}, ~${route.totalTime} –º–∏–Ω`;
                document.getElementById('preview-time').textContent = `${route.totalTime} –º–∏–Ω`;
                document.getElementById('preview-distance').textContent = `${route.distance} –∫–º`;
                document.getElementById('preview-cost').textContent = `~${route.totalCost} ‚ÇΩ`;

                const pointsHTML = route.points.map((p, i) => `
                    <div class="point-item">
                        <div class="point-item__header">
                            <div class="point-item__title">${p.name}</div>
                            <div class="point-item__time">${p.time} –º–∏–Ω</div>
                        </div>
                        <div class="point-item__description">${p.description}</div>
                        <div class="point-item__tags">
                            <span class="tag">üí∞ ${p.cost > 0 ? p.cost + ' ‚ÇΩ' : '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'}</span>
                        </div>
                    </div>
                `).join('');
                document.getElementById('preview-points').innerHTML = pointsHTML;
                app.log('preview_view', {
                    route_id: route.id,
                    poi_count: route.points.length,
                    total_time: route.totalTime,
                    total_cost: route.totalCost,
                    mode: route.mode,
                });
            },

            applyTuner: (tuner) => {
                app.log('regenerate_click', { constraint_type: tuner });
                app.toast(`–ü–µ—Ä–µ–ø–æ–¥–±–∏—Ä–∞–µ–º –º–∞—Ä—à—Ä—É—Ç (${tuner})...`, 'info');
                setTimeout(() => {
                    app.state.currentRoute.points[0].name += ' ‚ú®';
                    app.renderPreview();
                    app.toast('–ì–æ—Ç–æ–≤–æ!', 'success');
                }, 1500);
            },

            toggleMode: () => {
                app.state.mode = app.state.mode === 'walk' ? 'quest' : 'walk';
                app.toast(`–†–µ–∂–∏–º –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ ${app.state.mode === 'walk' ? '–ü—Ä–æ–≥—É–ª–∫—É' : '–ö–≤–µ—Å—Ç'}`, 'success');
            },

            saveRoute: () => {
                if (!app.state.currentRoute) return;
                app.state.savedRoutes.push(app.state.currentRoute);
                localStorage.setItem('kudapoydem_saved', JSON.stringify(app.state.savedRoutes));
                app.log('save_route', { context: app.currentScreen });
                app.toast('–ú–∞—Ä—à—Ä—É—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'success');
            },

            shareRoute: () => {
                app.log('share_route', { context: app.currentScreen });
                const text = `üöÄ –ú–∞—Ä—à—Ä—É—Ç –æ—Ç –ö—É–¥–∞–ü–æ–π–¥—ë–º: ${app.state.currentRoute.city}, ${app.state.currentRoute.totalTime} –º–∏–Ω, —Ä–µ–∂–∏–º ${app.state.mode === 'walk' ? '–ü—Ä–æ–≥—É–ª–∫–∞' : '–ö–≤–µ—Å—Ç'}`;
                if (navigator.share) {
                    navigator.share({ title: '–ö—É–¥–∞–ü–æ–π–¥—ë–º', text });
                } else {
                    app.toast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: ' + text, 'info');
                }
            },

            startRoute: () => {
                app.state.currentPointIndex = 0;
                app.state.completedPoints = [];
                app.log('route_start', { source: 'preview', mode: app.state.mode });
                app.showScreen('step');
                app.renderStep();
            },

            // STEP
            renderStep: () => {
                const route = app.state.currentRoute;
                const point = route.points[app.state.currentPointIndex];
                const progress = ((app.state.currentPointIndex + 1) / route.points.length) * 100;

                document.getElementById('step-title').textContent = `–¢–æ—á–∫–∞ ${app.state.currentPointIndex + 1} / ${route.points.length}`;
                document.getElementById('step-progress').style.width = progress + '%';
                document.getElementById('step-info').textContent = point.description;
                document.getElementById('step-name').textContent = point.name;
                document.getElementById('step-description').textContent = point.description;
                document.getElementById('step-time').textContent = `‚è±Ô∏è ${point.time} –º–∏–Ω—É—Ç –Ω–∞ –º–µ—Å—Ç–µ`;

                if (app.state.mode === 'quest') {
                    document.getElementById('quest-block').style.display = 'block';
                    document.getElementById('quest-text').textContent = point.quest;
                } else {
                    document.getElementById('quest-block').style.display = 'none';
                }
            },

            showQuestHint: () => {
                const hints = ['–ò—â–∏—Ç–µ —á—Ç–æ-—Ç–æ –Ω–µ–æ–±—ã—á–Ω–æ–µ', '–ó–∞–º–µ—Ç—å—Ç–µ –¥–µ—Ç–∞–ª–∏', '–°–ø—Ä–æ—Å–∏—Ç–µ –º–µ—Å—Ç–Ω—ã—Ö', '–ü–æ–∏—â–∏—Ç–µ —Ä—è–¥–æ–º'];
                const hint = hints[Math.floor(Math.random() * hints.length)];
                const hintEl = document.getElementById('quest-hint');
                hintEl.style.display = 'block';
                hintEl.textContent = 'üí° ' + hint;
                app.log('quest_hint', { point_id: app.state.currentRoute.points[app.state.currentPointIndex].id });
            },

            navigate: () => {
                const point = app.state.currentRoute.points[app.state.currentPointIndex];
                app.log('navigate_click', { point_id: point.id });
                app.toast('–û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É...', 'info');
            },

            checkInGeo: () => {
                app.log('step_checkin', { method: 'geo', success: true, distance: 0 });
                app.completePoint();
            },

            checkInQR: () => {
                app.log('step_checkin', { method: 'qr', success: true, distance: 0 });
                app.completePoint();
            },

            completePoint: () => {
                app.state.completedPoints.push(app.state.currentRoute.points[app.state.currentPointIndex].id);
                if (app.state.currentPointIndex < app.state.currentRoute.points.length - 1) {
                    app.state.currentPointIndex++;
                    app.renderStep();
                    app.toast('‚úÖ –ß–µ–∫-–∏–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω! –ò–¥—ë—Ç–µ –¥–∞–ª—å—à–µ?', 'success');
                } else {
                    app.log('route_finish', {
                        completed_points: app.state.completedPoints.length,
                        total_points: app.state.currentRoute.points.length,
                        mode: app.state.mode,
                    });
                    app.showScreen('finish');
                    app.renderFinish();
                }
            },

            skipPoint: () => {
                app.log('step_skip', { point_id: app.state.currentRoute.points[app.state.currentPointIndex].id });
                if (app.state.currentPointIndex < app.state.currentRoute.points.length - 1) {
                    app.state.currentPointIndex++;
                    app.renderStep();
                } else {
                    app.showScreen('finish');
                    app.renderFinish();
                }
            },

            // FINISH
            renderFinish: () => {
                const route = app.state.currentRoute;
                document.getElementById('finish-completed').textContent = `${app.state.completedPoints.length}/${route.points.length}`;
                document.getElementById('finish-time').textContent = `${Math.round(route.totalTime * 0.8)} –º–∏–Ω`;
                document.getElementById('finish-distance').textContent = route.distance + ' –∫–º';

                const pointsHTML = route.points.map(p => `
                    <div class="point-item">
                        <div class="point-item__header">
                            <div class="point-item__title">${p.name}</div>
                        </div>
                        <div class="point-item__description">${p.description}</div>
                    </div>
                `).join('');
                document.getElementById('finish-points').innerHTML = pointsHTML;
            },

            createNew: () => {
                app.log('create_new_click');
                app.state.currentRoute = null;
                app.state.currentPointIndex = 0;
                app.state.completedPoints = [];
                app.showScreen('onboard');
            },

            // SAVED ROUTES
            showSaved: () => {
                app.showScreen('saved');
                app.renderSaved();
            },

            renderSaved: () => {
                const listEl = document.getElementById('saved-list');
                const emptyEl = document.getElementById('saved-empty');

                if (app.state.savedRoutes.length === 0) {
                    listEl.innerHTML = '';
                    emptyEl.style.display = 'flex';
                    return;
                }

                emptyEl.style.display = 'none';
                listEl.innerHTML = app.state.savedRoutes.map((route, i) => `
                    <div class="saved-item">
                        <div class="saved-item__info">
                            <div class="saved-item__title">${route.city}</div>
                            <div class="saved-item__meta">${route.totalTime} –º–∏–Ω ¬∑ ${route.points.length} —Ç–æ—á–µ–∫ ¬∑ ${route.mode === 'walk' ? '–ü—Ä–æ–≥—É–ª–∫–∞' : '–ö–≤–µ—Å—Ç'}</div>
                        </div>
                        <div class="saved-item__actions">
                            <button class="btn btn--small btn--secondary" onclick="app.openSavedRoute(${i})">–û—Ç–∫—Ä—ã—Ç—å</button>
                        </div>
                    </div>
                `).join('');
                app.log('saved_view');
            },

            openSavedRoute: (index) => {
                app.state.currentRoute = app.state.savedRoutes[index];
                app.log('saved_open', { route_id: app.state.currentRoute.id });
                app.showScreen('preview');
                app.renderPreview();
            },
        };

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            app.log('app_launch', { platform: 'telegram_web_app' });
        });
    </script>
</body>
</html>