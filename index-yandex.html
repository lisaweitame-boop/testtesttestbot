<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö—É–¥–∞–ü–æ–π–¥—ë–º</title>
    <script type="text/javascript" src="https://gc.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=1REes-RrYxeN-sED8VPOTjlC5ub01DsUAp40HHSYDZjOAnSReAKq9vUBsVKd5QORLuvu0mDoHA623l_Tg6bdqDNS-zJTMOG3GmnAU0otrsFY9XRQ8Lpln6IXQUPTqDpeXHvoGjtdurHONucbKwc-Tjrl4IW8sEzKMxCkTJqE0inHXsp1islGGWKawpKoJtoqnJCjfUCYZ3i2_4Kd2tcMD0XowY3OYh-8-845JBt6-cVkyXTqVKBe7FsjENfXbxlRmw_uVtBAa1NA70M5cNQ143K_deJDaYUOBNuTP2g8UzWUpjT_Hl4hvyONSLoGpIGdNulfw2a6PrjPPhTQ23Zgn4biPEC59Dxy4JOF96b4e-IMEssFNuOzeF5aVT097eYqhJqgvnIbjcSgvwNmtmpJRsxxONzHuYhLj_YdHhMtQ9kiQqrEzwdfAkigON4fZeWIORD6gGre78ld2WOntyuKduUTahBlvg9OELVfyDA59e9rfAc4oaw4dR1YgJmqdWpVVNigRnYmVv8eQFNvaVGTd6eoBeTw4pLMtXkt6jrnwRzciZOjw9fWD-mY8EnMuMP03DHtIsrbJYhTjrnGHcOXewBm8M7X3HTvasoJXm-jr_OAn343SDjsKr-I83H2uTuUAq0ifxYO8adbOBfaQezyeFjTjXWqAjtmsrtV3NU10gnRy3-mAFQdZckzR3ZS5rwGX9lEcim-BVNkNdvgyVVDvpijYc368HaRiaBm7J0X57gn4jyNaOHBaOJLv59hJTSY_htcctdJjBSDF_QDN_37EIXIrHhNzmVl2iAC04WZXTCo4OKaI4n41mkbOTTmQ33FMAm8rLR01bzQRJKuQn0ThHfpVEDlqgH_koRUJnSb5kG-Izys-WEFLyhrXUhLh6c9rqtTf2ZcrpOByNXYYsl1lrb3GSbKX3yMJfmJXCCXiGSvHmJn7ZtaM6sQd_IGOx86zpRf58AceRfqload3p6b6VlOmZ5Z0W1HHkJyCFa8_I_zYzyELxYUljkCocgzFDQbmf-7Y2ZQmli-HhQiDlarbSCbYvopT4UESihbka6b7AK2nCWYKAlMU8Rc883gA_371G5eR9U2dobCG3Zpx9vw63z0GqBZ7CQ79goqp6ZL_JaIODmjkjxifvWbCalAlL0IvvzCTuL0U52vTfLrYoibd3ukUmKGdEREMiH0athQ1cqEebJkw7B5Ogk44dZqVyVP8xyv2Wa7K3VON48s61l7c2HLFsWyRpuc8Pr90U6cvuTTZZv8fGvrZeflL8So5u809kGLJq-ZhzY1y3ZG3oesyLGG0XClF7S-VM9RXZIoHuv5tuSp6osPiDNHwz5FCRoZ_PYaMhg6gNRnoWaMW2jWGowfEomu4UBgeLqnXLSIDLsqLotolamdPCL1WKdDC-O7oe391yukgj1J8WI84zrvVvjfYesxKIaFK6SL6DlmDG5nElRt5HMixjqYnn4Q-ZRm7PqgLgwGfSdDk7nIEWWtJUOAnXd_Zd7KpD7jvkiktjHnBVnhdoE0TBaHWUpU1plKBiNlsQTTFs56BPy7Jh8PmxXdd7YHoyfnHpU-pAYm-i4EAdw_SdZKQWHOGTUFW1dII9NcRi2TeVH0pnK8lUU2n7qvWWbOeFDLjknhFh8U2dZJLyLto1fXbTWOsEs6Vfpv2JSj9HEhxDBMm4Duayo6GtqbXHgimY03FFKapdGixpJ5_54LyUk8Ct5cp9lF6NDiQxZVOzevqLdD0lZ7opnN3m6cl-3YCyEK3WMOd7PZ1CNzm7R88QlOq-2m2VzxfbULPWp45ieCYjIHOM0aux8uV5gk2t3dW_edqTTbCZAgdzeVimHnaSbSb1AVgXpfvXYRngcCD8H_a6rwcqKZjIYFhVVKUpBeChKXqRoZQS9sc8jh-1ZoeO7Crea3LD9f28BVTXxJyHyXvkbyk23uiZNXAHgqH8cY5RpI9Xj2TrO4qWgTcQ92ErrBMi_-UQ84Rr4MB0pAr8OD7LYp9E0II7815cUi09IdvrUQ80sTaA46rzwPRXlzSOwmDCRuFQh2DzpvsNwA8UoJDj6C_P19XFBqi2ih__frkv5N1UMDry4ol2MiXoftGyVEVoIfPMM0wvQN3I6LyKfyhtaMLUwCpCINsRhNuisfTaMrMXaSRfhbYMJmuKuLzc_CzEu_XQj1jZQqODVBpT4U21kwqIAI8avNeAaPO1gGxp_zaXdzw66QaVbfaywXAg-Twtijd8hjwn9X" charset="UTF-8"></script><script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=YOUR_YANDEX_API_KEY&lang=ru_RU"></script>
    <style>
        :root {
            --primary: #2181CE;
            --primary-hover: #1A6BB8;
            --bg: #f5f5f5;
            --surface: #ffffff;
            --text: #1a1a1a;
            --text-secondary: #666;
            --border: #e0e0e0;
            --success: #31c27e;
            --error: #ff4444;
            --warning: #ffa500;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
        }

        .app {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .screen {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding: 0;
            animation: fadeIn 0.2s ease-in;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            min-height: 50px;
        }

        .top-bar__back {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            color: var(--primary);
        }

        .top-bar__title {
            flex: 1;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
        }

        .top-bar__spacer {
            width: 32px;
        }

        .screen__content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow-y: auto;
        }

        .container {
            padding: 16px;
            flex: 1;
        }

        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            gap: 8px;
        }

        .btn--primary {
            background: var(--primary);
            color: #fff;
            width: 100%;
        }

        .btn--primary:active {
            background: var(--primary-hover);
            transform: scale(0.98);
        }

        .btn--secondary {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
            width: 100%;
        }

        .btn--secondary:active {
            background: var(--border);
        }

        .btn--small {
            padding: 8px 12px;
            font-size: 14px;
            width: auto;
        }

        .btn--text {
            background: none;
            color: var(--primary);
            padding: 8px;
            font-size: 14px;
            text-decoration: underline;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .screen__footer {
            padding: 16px;
            background: var(--surface);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            flex-direction: column;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            background: var(--surface);
            color: var(--text);
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(33, 129, 206, 0.1);
        }

        .form-error {
            color: var(--error);
            font-size: 12px;
            margin-top: 4px;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .card__title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .card__subtitle {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .goal-card {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 12px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 8px;
        }

        .goal-card.active {
            border-color: var(--primary);
            background: rgba(33, 129, 206, 0.05);
        }

        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .chip {
            padding: 8px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chip.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        .toggle {
            display: flex;
            background: var(--bg);
            border-radius: 6px;
            padding: 4px;
            gap: 4px;
        }

        .toggle__option {
            flex: 1;
            padding: 8px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 4px;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .toggle__option.active {
            background: var(--surface);
            color: var(--primary);
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--bg);
            border-radius: 2px;
            overflow: hidden;
            margin: 12px 0;
        }

        .progress-bar__fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text);
            color: #fff;
            padding: 12px 16px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 14px;
            max-width: 90%;
            text-align: center;
            animation: slideUp 0.2s ease;
        }

        .toast.error {
            background: var(--error);
        }

        .toast.success {
            background: var(--success);
        }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .map-container {
            width: 100%;
            height: 280px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }

        #ymap {
            width: 100%;
            height: 100%;
        }

        .summary {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
            background: var(--bg);
            padding: 12px;
            border-radius: 8px;
        }

        .summary__item {
            text-align: center;
        }

        .summary__label {
            color: var(--text-secondary);
            font-size: 11px;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .summary__value {
            font-weight: 600;
            font-size: 14px;
        }

        .points-list {
            margin-bottom: 16px;
        }

        .point-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .point-item:active {
            background: var(--bg);
        }

        .point-item__header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .point-item__title {
            font-weight: 600;
            font-size: 14px;
            flex: 1;
        }

        .point-item__time {
            color: var(--text-secondary);
            font-size: 12px;
            white-space: nowrap;
        }

        .point-item__description {
            color: var(--text-secondary);
            font-size: 12px;
            margin-bottom: 8px;
        }

        .point-item__tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .tag {
            background: var(--bg);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .tuners {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tuner {
            padding: 8px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tuner.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        .onboarding {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px 16px;
        }

        .onboarding__logo {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .onboarding__title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .onboarding__subtitle {
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 14px;
        }

        .presets {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }

        .preset-btn {
            padding: 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            font-weight: 500;
        }

        .preset-btn.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        .step-header {
            background: var(--surface);
            padding: 16px;
            border-bottom: 1px solid var(--border);
            text-align: center;
        }

        .step-header__title {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .step-header__info {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 16px;
            text-align: center;
            flex: 1;
        }

        .empty-state__icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state__text {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .saved-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .saved-item__info {
            flex: 1;
        }

        .saved-item__title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .saved-item__meta {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .saved-item__actions {
            display: flex;
            gap: 8px;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- SCREEN 1: ONBOARDING -->
        <div class="screen active" id="screen-onboard">
            <div class="screen__content">
                <div class="container onboarding">
                    <div class="onboarding__logo">üö∂</div>
                    <h1 class="onboarding__title">–ö—É–¥–∞–ü–æ–π–¥—ë–º</h1>
                    <p class="onboarding__subtitle">–ò–¥–µ–∞–ª—å–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç –∑–∞ 1 –º–∏–Ω—É—Ç—É</p>
                    
                    <div style="width: 100%; text-align: left; margin-bottom: 24px;">
                        <div class="goal-card" onclick="app.selectGoal(0)">
                            <div>‚è±Ô∏è 2 —á–∞—Å–∞ –±–µ–∑ –æ—á–µ—Ä–µ–¥–µ–π</div>
                        </div>
                        <div class="goal-card" onclick="app.selectGoal(1)">
                            <div>‚ö° 30‚Äì60 –º–∏–Ω –º–µ–∂–¥—É –ø–∞—Ä–∞–º–∏</div>
                        </div>
                        <div class="goal-card" onclick="app.selectGoal(2)">
                            <div>üèòÔ∏è –û—Å–≤–æ–∏—Ç—å —Ä–∞–π–æ–Ω</div>
                        </div>
                    </div>

                    <div class="form-group" style="width: 100%;">
                        <div class="form-label">–†–µ–∂–∏–º</div>
                        <div class="toggle">
                            <button class="toggle__option active" onclick="app.setMode('walk')">–ü—Ä–æ–≥—É–ª–∫–∞</button>
                            <button class="toggle__option" onclick="app.setMode('quest')">–ö–≤–µ—Å—Ç</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="screen__footer">
                <button class="btn btn--primary" onclick="app.goToCriteria()">–ù–∞—á–∞—Ç—å</button>
                <button class="btn btn--text" onclick="app.showHowWorks()">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</button>
            </div>
        </div>

        <!-- SCREEN 2: CRITERIA -->
        <div class="screen" id="screen-criteria">
            <div class="top-bar">
                <button class="top-bar__back" onclick="app.back()">‚Üê –ù–∞–∑–∞–¥</button>
                <div class="top-bar__title">–ö—Ä–∏—Ç–µ—Ä–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞</div>
                <div class="top-bar__spacer"></div>
            </div>
            <div class="screen__content">
                <div class="container">
                    <div class="form-group">
                        <div class="form-label">–ü—Ä–µ—Å–µ—Ç—ã</div>
                        <div class="presets">
                            <button class="preset-btn" onclick="app.applyPreset('tourist')">–¢—É—Ä–∏—Å—Ç</button>
                            <button class="preset-btn" onclick="app.applyPreset('student')">–°—Ç—É–¥–µ–Ω—Ç</button>
                            <button class="preset-btn" onclick="app.applyPreset('newcomer')">–ü–µ—Ä–µ—Å–µ–ª–µ–Ω–µ—Ü</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-label">–õ–æ–∫–∞—Ü–∏—è</div>
                        <button class="btn btn--secondary btn--small" style="width: 100%; margin-bottom: 8px;" onclick="app.requestGeo()">üìç –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ—é –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é</button>
                        <input type="text" class="form-input" id="city-input" placeholder="–ì–æ—Ä–æ–¥ –∏–ª–∏ —Ä–∞–π–æ–Ω" value="">
                        <div class="form-error" id="city-error"></div>
                    </div>

                    <div class="form-group">
                        <div class="form-label">–í—Ä–µ–º—è (–º–∏–Ω—É—Ç)</div>
                        <div class="chips">
                            <div class="chip" onclick="app.setTime(45)">30‚Äì60</div>
                            <div class="chip" onclick="app.setTime(105)">90‚Äì120</div>
                            <div class="chip" onclick="app.setTime(150)">120‚Äì180</div>
                            <div class="chip" onclick="app.setTime(null)">–ö–∞—Å—Ç–æ–º</div>
                        </div>
                        <input type="number" class="form-input" id="time-custom" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω—É—Ç" style="display: none;" min="10" max="480">
                        <div class="form-error" id="time-error"></div>
                    </div>

                    <div class="form-group">
                        <div class="form-label">–ë—é–¥–∂–µ—Ç</div>
                        <select class="form-select" id="budget">
                            <option value="free">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</option>
                            <option value="budget">–î–æ 500 —Ä.</option>
                            <option value="moderate">–î–æ 2000 —Ä.</option>
                            <option value="any">–ù–µ –≤–∞–∂–Ω–æ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <div class="form-label">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</div>
                        <div class="chips" id="mood-chips">
                            <div class="chip" onclick="app.toggleMood(this, 'relax')">üßò –†–µ–ª–∞–∫—Å</div>
                            <div class="chip" onclick="app.toggleMood(this, 'active')">üèÉ –ê–∫—Ç–∏–≤–Ω–æ</div>
                            <div class="chip" onclick="app.toggleMood(this, 'cultural')">üé® –ö—É–ª—å—Ç—É—Ä–∞</div>
                            <div class="chip" onclick="app.toggleMood(this, 'food')">üçΩÔ∏è –ï–¥–∞</div>
                            <div class="chip" onclick="app.toggleMood(this, 'photo')">üì∏ –§–æ—Ç–æ</div>
                            <div class="chip" onclick="app.toggleMood(this, 'shop')">üõçÔ∏è –®–æ–ø–∏–Ω–≥</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-label">–ö–æ–º–ø–∞–Ω–∏—è</div>
                        <select class="form-select" id="company">
                            <option value="alone">–û–¥–∏–Ω</option>
                            <option value="couple">–ü–∞—Ä–∞</option>
                            <option value="friends">–î—Ä—É–∑—å—è</option>
                            <option value="family">–°–µ–º—å—è</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="no-queue" style="width: 18px; height: 18px;">
                            <span>–ë–µ–∑ –æ—á–µ—Ä–µ–¥–µ–π</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="screen__footer">
                <button class="btn btn--primary" onclick="app.generateRoute()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>

        <!-- SCREEN 3: GENERATING -->
        <div class="screen" id="screen-generating">
            <div class="screen__content">
                <div class="container" style="display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
                    <div class="spinner"></div>
                    <p style="margin-top: 24px; font-weight: 600;">–ö—É–¥–∞–ü–æ–π–¥—ë–º –ø–æ–¥–±–∏—Ä–∞–µ—Ç —Ç–æ—á–∫–∏‚Ä¶</p>
                    <p style="color: var(--text-secondary); font-size: 13px; margin-top: 8px;" id="gen-tip">‚ú® –°–æ–≤–µ—Ç: –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç—É —Å –º–∞—Ä—à—Ä—É—Ç–æ–º</p>
                    <div class="progress-bar" style="margin-top: 32px; width: 80%;">
                        <div class="progress-bar__fill" style="width: 0%;" id="gen-progress"></div>
                    </div>
                </div>
            </div>
            <div class="screen__footer">
                <button class="btn btn--secondary" onclick="app.cancelGenerate()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>

        <!-- SCREEN 4: PREVIEW -->
        <div class="screen" id="screen-preview">
            <div class="top-bar">
                <button class="top-bar__back" onclick="app.back()">‚Üê –ù–∞–∑–∞–¥</button>
                <div class="top-bar__title">–ú–∞—Ä—à—Ä—É—Ç</div>
                <div class="top-bar__spacer"></div>
            </div>
            <div class="screen__content">
                <div class="container">
                    <h2 id="preview-title" style="margin-bottom: 4px;">–ú–∞—Ä—à—Ä—É—Ç –æ—Ç –ö—É–¥–∞–ü–æ–π–¥—ë–º</h2>
                    <p id="preview-subtitle" style="color: var(--text-secondary); margin-bottom: 16px;">–≥–æ—Ä–æ–¥, 1 —á–∞—Å</p>
                    
                    <div class="map-container">
                        <div id="ymap"></div>
                    </div>

                    <div class="summary">
                        <div class="summary__item">
                            <div class="summary__label">–í—Ä–µ–º—è</div>
                            <div class="summary__value" id="preview-time">90 –º–∏–Ω</div>
                        </div>
                        <div class="summary__item">
                            <div class="summary__label">–ü–µ—à–∫–æ–º</div>
                            <div class="summary__value" id="preview-distance">2.5 –∫–º</div>
                        </div>
                        <div class="summary__item">
                            <div class="summary__label">–ë—é–¥–∂–µ—Ç</div>
                            <div class="summary__value" id="preview-cost">~500 ‚ÇΩ</div>
                        </div>
                    </div>

                    <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">–¢—é–Ω–µ—Ä—ã</h3>
                    <div class="tuners">
                        <button class="tuner" onclick="app.applyTuner('walk')">üö∂ –ú–µ–Ω—å—à–µ —Ö–æ–¥—å–±—ã</button>
                        <button class="tuner" onclick="app.applyTuner('cheap')">üí∞ –î–µ—à–µ–≤–ª–µ</button>
                        <button class="tuner" onclick="app.applyTuner('local')">üèòÔ∏è –õ–æ–∫–∞–ª—å–Ω–æ–µ</button>
                    </div>

                    <h3 style="font-size: 14px; font-weight: 600; margin: 16px 0 8px 0;">–¢–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞</h3>
                    <div class="points-list" id="preview-points"></div>
                </div>
            </div>
            <div class="screen__footer">
                <button class="btn btn--primary" onclick="app.startRoute()">üöÄ –°—Ç–∞—Ä—Ç –º–∞—Ä—à—Ä—É—Ç–∞</button>
                <button class="btn btn--secondary" onclick="app.toggleMode()">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º</button>
                <button class="btn btn--text" onclick="app.saveRoute()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn btn--text" onclick="app.shareRoute()">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
            </div>
        </div>

        <!-- SCREEN 5: STEP (Point) -->
        <div class="screen" id="screen-step">
            <div class="step-header">
                <div class="step-header__title" id="step-title">–¢–æ—á–∫–∞ 1 / 5</div>
                <div class="progress-bar">
                    <div class="progress-bar__fill" style="width: 20%;" id="step-progress"></div>
                </div>
                <div class="step-header__info" id="step-info">–û—Ç–∫—Ä–æ–π—Ç–µ –¥–ª—è —Å–µ–±—è –Ω–æ–≤–æ–µ –º–µ—Å—Ç–æ</div>
            </div>
            <div class="screen__content">
                <div class="container">
                    <div class="card">
                        <div class="card__title" id="step-name">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏</div>
                        <div class="card__subtitle" id="step-description">–û–ø–∏—Å–∞–Ω–∏–µ</div>
                        <div style="margin-top: 12px; color: var(--text-secondary); font-size: 12px;" id="step-time">‚è±Ô∏è 20 –º–∏–Ω—É—Ç –Ω–∞ –º–µ—Å—Ç–µ</div>
                    </div>

                    <div id="quest-block" style="display: none;">
                        <div class="card">
                            <div class="card__title">üìù –ó–∞–¥–∞–Ω–∏–µ</div>
                            <div class="card__subtitle" id="quest-text">–ù–∞–π–¥–∏—Ç–µ —Ñ–æ–Ω—Ç–∞–Ω –∏ —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ</div>
                            <button class="btn btn--text" onclick="app.showQuestHint()" style="margin-top: 8px;">–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É</button>
                            <div id="quest-hint" style="margin-top: 8px; padding: 8px; background: var(--bg); border-radius: 6px; font-size: 12px; color: var(--text-secondary); display: none;"></div>
                        </div>
                    </div>

                    <button class="btn btn--secondary" style="margin: 16px 0;" onclick="app.navigate()">üó∫Ô∏è –ù–∞–≤–∏–≥–∏—Ä–æ–≤–∞—Ç—å</button>

                    <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">–ß–µ–∫-–∏–Ω</h3>
                </div>
            </div>
            <div class="screen__footer">
                <button class="btn btn--primary" onclick="app.checkInGeo()">‚úÖ –Ø –Ω–∞ –º–µ—Å—Ç–µ</button>
                <button class="btn btn--secondary" onclick="app.checkInQR()">üì± –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>
                <button class="btn btn--text" onclick="app.skipPoint()">‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
            </div>
        </div>

        <!-- SCREEN 6: FINISH -->
        <div class="screen" id="screen-finish">
            <div class="top-bar">
                <div class="top-bar__back" style="visibility: hidden;">‚Üê –ù–∞–∑–∞–¥</div>
                <div class="top-bar__title">–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ</div>
                <div class="top-bar__spacer"></div>
            </div>
            <div class="screen__content">
                <div class="container">
                    <h1 style="text-align: center; margin-bottom: 8px; margin-top: 24px;">üéâ –ì–æ—Ç–æ–≤–æ!</h1>
                    <p style="text-align: center; color: var(--text-secondary); margin-bottom: 24px;">–≠—Ç–æ –±—ã–ª –º–∞—Ä—à—Ä—É—Ç –æ—Ç –ö—É–¥–∞–ü–æ–π–¥—ë–º</p>

                    <div class="summary">
                        <div class="summary__item">
                            <div class="summary__label">–ü—Ä–æ–π–¥–µ–Ω–æ</div>
                            <div class="summary__value" id="finish-completed">5/5</div>
                        </div>
                        <div class="summary__item">
                            <div class="summary__label">–í—Ä–µ–º—è</div>
                            <div class="summary__value" id="finish-time">1 —á 45 –º</div>
                        </div>
                        <div class="summary__item">
                            <div class="summary__label">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ</div>
                            <div class="summary__value" id="finish-distance">3 –∫–º</div>
                        </div>
                    </div>

                    <h3 style="font-size: 14px; font-weight: 600; margin: 16px 0 8px 0;">–ü–æ—Å–µ—â—ë–Ω–Ω—ã–µ —Ç–æ—á–∫–∏</h3>
                    <div class="points-list" id="finish-points"></div>
                </div>
            </div>
            <div class="screen__footer">
                <button class="btn btn--primary" onclick="app.saveRoute()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
                <button class="btn btn--secondary" onclick="app.shareRoute()">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
                <button class="btn btn--text" onclick="app.createNew()">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π</button>
            </div>
        </div>

        <!-- SCREEN 7: SAVED ROUTES -->
        <div class="screen" id="screen-saved">
            <div class="top-bar">
                <button class="top-bar__back" onclick="app.back()">‚Üê –ù–∞–∑–∞–¥</button>
                <div class="top-bar__title">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ</div>
                <div class="top-bar__spacer"></div>
            </div>
            <div class="screen__content">
                <div class="container">
                    <div id="saved-list"></div>
                    <div id="saved-empty" class="empty-state">
                        <div class="empty-state__icon">üìå</div>
                        <p class="empty-state__text">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤</p>
                    </div>
                </div>
            </div>
            <div class="screen__footer">
                <button class="btn btn--primary" onclick="app.goToCriteria()">‚ûï –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
            </div>
        </div>
    </div>

    <script>
        if (window.Telegram && window.Telegram.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        const app = {
            currentScreen: 'onboard',
            map: null,
            multiRoute: null,
            state: {
                mode: 'walk',
                goal: null,
                city: '',
                time: 60,
                budget: 'free',
                mood: [],
                company: 'alone',
                noQueue: true,
                preset: null,
                currentRoute: null,
                currentPointIndex: 0,
                completedPoints: [],
                savedRoutes: JSON.parse(localStorage.getItem('kudapoydem_saved') || '[]'),
            },

            log: (event, props = {}) => {
                console.log(`[Analytics] ${event}`, props);
            },

            showScreen: (screenId) => {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(`screen-${screenId}`).classList.add('active');
                app.currentScreen = screenId;
                app.log('screen_view', { screen: screenId });
                
                if (screenId === 'preview' && app.map === null) {
                    setTimeout(() => app.initMap(), 100);
                }
            },

            toast: (message, type = 'info') => {
                const t = document.createElement('div');
                t.className = `toast ${type}`;
                t.textContent = message;
                document.body.appendChild(t);
                setTimeout(() => t.remove(), 3000);
            },

            back: () => {
                if (app.currentScreen === 'criteria') app.showScreen('onboard');
                else if (app.currentScreen === 'preview') app.showScreen('criteria');
                else if (app.currentScreen === 'step') app.showScreen('preview');
                else if (app.currentScreen === 'saved') app.showScreen('onboard');
            },

            // ONBOARDING
            selectGoal: (index) => {
                app.state.goal = index;
                document.querySelectorAll('#screen-onboard .goal-card').forEach((el, i) => {
                    el.classList.toggle('active', i === index);
                });
            },

            setMode: (mode) => {
                app.state.mode = mode;
                document.querySelectorAll('#screen-onboard .toggle__option').forEach(el => {
                    el.classList.toggle('active', el.textContent.includes(mode === 'walk' ? '–ü—Ä–æ–≥—É–ª–∫–∞' : '–ö–≤–µ—Å—Ç'));
                });
                app.log('onboard_mode_toggle', { mode });
            },

            showHowWorks: () => {
                app.toast('1) –í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ 2) –ù–∞–π–¥—ë–º –º–∞—Ä—à—Ä—É—Ç –Ω–∞ –∫–∞—Ä—Ç–µ 3) –•–æ–¥–∏—Ç–µ –∏ —á–µ–∫–∏–Ω—å—Ç–µ —Ç–æ—á–∫–∏', 'info');
            },

            goToCriteria: () => {
                app.log('onboard_continue_click', { preset: app.state.preset });
                app.showScreen('criteria');
            },

            // CRITERIA
            requestGeo: () => {
                app.log('geo_request_click');
                if (!navigator.geolocation) {
                    app.toast('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        app.state.city = `${pos.coords.latitude.toFixed(2)}, ${pos.coords.longitude.toFixed(2)}`;
                        document.getElementById('city-input').value = '–í–∞—à–∞ –ª–æ–∫–∞—Ü–∏—è';
                        app.toast('–õ–æ–∫–∞—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞', 'success');
                    },
                    () => {
                        app.toast('–í–∫–ª—é—á–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏', 'error');
                    }
                );
            },

            applyPreset: (preset) => {
                app.state.preset = preset;
                const presets = {
                    tourist: { budget: 'moderate', noQueue: true, mood: ['photo', 'cultural'] },
                    student: { budget: 'free', noQueue: false, mood: ['active', 'food'] },
                    newcomer: { budget: 'budget', noQueue: false, mood: ['cultural', 'relax'] },
                };
                Object.assign(app.state, presets[preset]);
                document.querySelectorAll('.preset-btn').forEach((el, i) => {
                    el.classList.toggle('active', ['tourist', 'student', 'newcomer'][i] === preset);
                });
                app.log('preset_selected', { preset });
            },

            setTime: (minutes) => {
                if (minutes === null) {
                    document.getElementById('time-custom').style.display = 'block';
                    app.state.time = 0;
                } else {
                    document.getElementById('time-custom').style.display = 'none';
                    app.state.time = minutes;
                    document.querySelectorAll('#screen-criteria .chips .chip').forEach((el, i) => {
                        const times = [45, 105, 150];
                        el.classList.toggle('active', times[i] === minutes);
                    });
                }
            },

            toggleMood: (el, mood) => {
                if (app.state.mood.includes(mood)) {
                    app.state.mood = app.state.mood.filter(m => m !== mood);
                } else {
                    app.state.mood.push(mood);
                }
                el.classList.toggle('active');
            },

            generateRoute: () => {
                const city = document.getElementById('city-input').value;
                const timeVal = document.getElementById('time-custom').style.display === 'block' 
                    ? parseInt(document.getElementById('time-custom').value) 
                    : app.state.time;

                if (!city) {
                    document.getElementById('city-error').textContent = '–£–∫–∞–∂–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é';
                    return;
                }
                if (!timeVal) {
                    document.getElementById('time-error').textContent = '–£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è';
                    return;
                }

                app.state.city = city;
                app.state.time = timeVal;
                app.state.budget = document.getElementById('budget').value;
                app.state.company = document.getElementById('company').value;
                app.state.noQueue = document.getElementById('no-queue').checked;

                app.log('form_submit', {
                    preset: app.state.preset,
                    time_min: app.state.time,
                    budget: app.state.budget,
                    mood: app.state.mood,
                    company: app.state.company,
                    noQueue: app.state.noQueue,
                    mode: app.state.mode,
                });

                app.showScreen('generating');
                app.simulateGeneration();
            },

            cancelGenerate: () => {
                app.log('generate_cancel_click');
                app.showScreen('criteria');
            },

            simulateGeneration: () => {
                app.log('generate_start');
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 30;
                    if (progress > 95) progress = 95;
                    document.getElementById('gen-progress').style.width = progress + '%';
                    
                    const tips = ['‚ú® –ü–æ–¥–±–∏—Ä–∞–µ–º –º–∞—Ä—à—Ä—É—Ç...', 'üó∫Ô∏è –ó–∞–≥—Ä—É–∂–∞–µ–º –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã...', 'üèôÔ∏è –ò—â–µ–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –º–µ—Å—Ç–∞...'];
                    document.getElementById('gen-tip').textContent = tips[Math.floor(Math.random() * tips.length)];

                    if (progress >= 95) {
                        clearInterval(interval);
                        app.generateRouteWithYandex();
                    }
                }, 300);
            },

            generateRouteWithYandex: () => {
                if (typeof ymaps === 'undefined') {
                    app.toast('–ö–∞—Ä—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á', 'error');
                    app.showScreen('criteria');
                    return;
                }

                const searchQueries = {
                    cultural: ['–º—É–∑–µ–π', '–≥–∞–ª–µ—Ä–µ—è', '–ø–∞–º—è—Ç–Ω–∏–∫'],
                    food: ['–∫–∞—Ñ–µ', '—Ä–µ—Å—Ç–æ—Ä–∞–Ω', '–ø–∏—Ü—Ü–µ—Ä–∏—è'],
                    relax: ['–ø–∞—Ä–∫', '–∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä', 'spa'],
                    active: ['—Å–ø–æ—Ä—Ç–∑–∞–ª', '—Å–∫–∞–ª–æ–¥—Ä–æ–º', '–±–æ—É–ª–∏–Ω–≥'],
                    photo: ['—Ñ–æ–Ω—Ç–∞–Ω', '–ø–∞–º—è—Ç–Ω–∏–∫', '–ø–∞—Ä–∫'],
                    shop: ['—Ç–æ—Ä–≥–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä', '–º–∞–≥–∞–∑–∏–Ω'],
                };

                const queries = [];
                if (app.state.mood.length > 0) {
                    app.state.mood.forEach(mood => {
                        if (searchQueries[mood]) {
                            queries.push(searchQueries[mood][0]);
                        }
                    });
                }
                if (queries.length === 0) {
                    queries.push('–∫–∞—Ñ–µ', '–ø–∞—Ä–∫', '–º—É–∑–µ–π');
                }

                const geocoder = ymaps.geocode(app.state.city);
                geocoder.then((res) => {
                    const geoObject = res.geoObjects.get(0);
                    if (!geoObject) {
                        app.toast('–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π', 'error');
                        app.showScreen('criteria');
                        return;
                    }

                    const coords = geoObject.geometry.getCoordinates();
                    const points = [];
                    let counter = 0;

                    const searchPoint = (query, callback) => {
                        const searchPromise = ymaps.geocode(query + ' ' + app.state.city);
                        searchPromise.then((res) => {
                            const items = res.geoObjects.filter(obj => obj.geometry.getType() === 'Point');
                            if (items.length > 0 && counter < 5) {
                                const item = items[Math.floor(Math.random() * items.length)];
                                const cost = app.state.budget === 'free' ? 0 : Math.floor(Math.random() * 500) + 100;
                                points.push({
                                    id: counter + 1,
                                    name: item.properties.get('name') || query,
                                    description: query,
                                    coords: item.geometry.getCoordinates(),
                                    time: 20 + Math.floor(Math.random() * 20),
                                    cost: cost,
                                    quest: `–ù–∞–π–¥–∏—Ç–µ –∏ —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ ${query.toLowerCase()}`
                                });
                                counter++;
                            }
                            callback();
                        }).catch(callback);
                    };

                    let completed = 0;
                    const onSearchComplete = () => {
                        completed++;
                        if (completed === queries.length) {
                            if (points.length === 0) {
                                app.toast('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ç–æ—á–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥', 'error');
                                app.showScreen('criteria');
                                return;
                            }

                            points.sort(() => Math.random() - 0.5).splice(5);

                            const totalTime = Math.min(app.state.time, points.reduce((sum, p) => sum + p.time, 0) + 30);
                            const totalCost = points.reduce((sum, p) => sum + p.cost, 0);

                            app.state.currentRoute = {
                                id: `route_${Date.now()}`,
                                city: app.state.city,
                                mode: app.state.mode,
                                totalTime,
                                totalCost,
                                distance: (Math.random() * 5 + 1).toFixed(1),
                                centerCoords: coords,
                                points
                            };

                            app.log('generate_success', {
                                route_id: app.state.currentRoute.id,
                                poi_count: app.state.currentRoute.points.length,
                                total_time: app.state.currentRoute.totalTime,
                                total_cost: app.state.currentRoute.totalCost,
                            });

                            app.showScreen('preview');
                            app.renderPreview();
                        }
                    };

                    queries.forEach(query => searchPoint(query, onSearchComplete));
                }).catch(() => {
                    app.toast('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–∞', 'error');
                    app.showScreen('criteria');
                });
            },

            initMap: () => {
                if (app.map || !app.state.currentRoute) return;

                const container = document.getElementById('ymap');
                if (!container) return;

                const route = app.state.currentRoute;
                const coords = route.centerCoords || [55.75, 37.62];

                app.map = new ymaps.Map(container, {
                    center: coords,
                    zoom: 13,
                    controls: ['zoomControl']
                });

                const points = route.points.map(p => p.coords);
                if (points.length > 0) {
                    const waypoints = points.map((coords, i) => ({
                        point: coords,
                        title: `${i + 1}. ${route.points[i].name}`
                    }));

                    app.multiRoute = new ymaps.multiRouter.MultiRoute({
                        referencePoints: waypoints.map(w => w.point),
                        params: {
                            routingMode: 'masstransit'
                        }
                    }, {
                        boundsAutoApply: true
                    });

                    app.map.geoObjects.add(app.multiRoute);

                    route.points.forEach((point, i) => {
                        const placemark = new ymaps.Placemark(point.coords, {
                            balloonContent: `<strong>${point.name}</strong><br/>${point.description}<br/>üí∞ ${point.cost > 0 ? point.cost + ' ‚ÇΩ' : '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'}`
                        }, {
                            preset: 'islands#blueCircleDotIcon'
                        });
                        app.map.geoObjects.add(placemark);
                    });
                }
            },

            renderPreview: () => {
                const route = app.state.currentRoute;
                document.getElementById('preview-title').textContent = `–ú–∞—Ä—à—Ä—É—Ç –æ—Ç –ö—É–¥–∞–ü–æ–π–¥—ë–º`;
                document.getElementById('preview-subtitle').textContent = `${route.city}, ~${route.totalTime} –º–∏–Ω`;
                document.getElementById('preview-time').textContent = `${route.totalTime} –º–∏–Ω`;
                document.getElementById('preview-distance').textContent = `${route.distance} –∫–º`;
                document.getElementById('preview-cost').textContent = `~${route.totalCost} ‚ÇΩ`;

                const pointsHTML = route.points.map((p, i) => `
                    <div class="point-item">
                        <div class="point-item__header">
                            <div class="point-item__title">${p.name}</div>
                            <div class="point-item__time">${p.time} –º–∏–Ω</div>
                        </div>
                        <div class="point-item__description">${p.description}</div>
                        <div class="point-item__tags">
                            <span class="tag">üí∞ ${p.cost > 0 ? p.cost + ' ‚ÇΩ' : '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'}</span>
                        </div>
                    </div>
                `).join('');
                document.getElementById('preview-points').innerHTML = pointsHTML;
                app.log('preview_view', {
                    route_id: route.id,
                    poi_count: route.points.length,
                    total_time: route.totalTime,
                    total_cost: route.totalCost,
                    mode: route.mode,
                });
            },

            applyTuner: (tuner) => {
                app.log('regenerate_click', { constraint_type: tuner });
                app.toast(`–ü–µ—Ä–µ–ø–æ–¥–±–∏—Ä–∞–µ–º –º–∞—Ä—à—Ä—É—Ç (${tuner})...`, 'info');
                setTimeout(() => {
                    app.renderPreview();
                    app.toast('–ì–æ—Ç–æ–≤–æ!', 'success');
                }, 1500);
            },

            toggleMode: () => {
                app.state.mode = app.state.mode === 'walk' ? 'quest' : 'walk';
                app.toast(`–†–µ–∂–∏–º –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ ${app.state.mode === 'walk' ? '–ü—Ä–æ–≥—É–ª–∫—É' : '–ö–≤–µ—Å—Ç'}`, 'success');
            },

            saveRoute: () => {
                if (!app.state.currentRoute) return;
                app.state.savedRoutes.push(app.state.currentRoute);
                localStorage.setItem('kudapoydem_saved', JSON.stringify(app.state.savedRoutes));
                app.log('save_route', { context: app.currentScreen });
                app.toast('–ú–∞—Ä—à—Ä—É—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'success');
            },

            shareRoute: () => {
                app.log('share_route', { context: app.currentScreen });
                const text = `üöÄ –ú–∞—Ä—à—Ä—É—Ç –æ—Ç –ö—É–¥–∞–ü–æ–π–¥—ë–º: ${app.state.currentRoute.city}, ${app.state.currentRoute.totalTime} –º–∏–Ω, —Ä–µ–∂–∏–º ${app.state.mode === 'walk' ? '–ü—Ä–æ–≥—É–ª–∫–∞' : '–ö–≤–µ—Å—Ç'}`;
                if (navigator.share) {
                    navigator.share({ title: '–ö—É–¥–∞–ü–æ–π–¥—ë–º', text });
                } else {
                    app.toast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: ' + text, 'info');
                }
            },

            startRoute: () => {
                app.state.currentPointIndex = 0;
                app.state.completedPoints = [];
                app.log('route_start', { source: 'preview', mode: app.state.mode });
                app.map = null;
                app.showScreen('step');
                app.renderStep();
            },

            renderStep: () => {
                const route = app.state.currentRoute;
                const point = route.points[app.state.currentPointIndex];
                const progress = ((app.state.currentPointIndex + 1) / route.points.length) * 100;

                document.getElementById('step-title').textContent = `–¢–æ—á–∫–∞ ${app.state.currentPointIndex + 1} / ${route.points.length}`;
                document.getElementById('step-progress').style.width = progress + '%';
                document.getElementById('step-info').textContent = point.description;
                document.getElementById('step-name').textContent = point.name;
                document.getElementById('step-description').textContent = point.description;
                document.getElementById('step-time').textContent = `‚è±Ô∏è ${point.time} –º–∏–Ω—É—Ç –Ω–∞ –º–µ—Å—Ç–µ`;

                if (app.state.mode === 'quest') {
                    document.getElementById('quest-block').style.display = 'block';
                    document.getElementById('quest-text').textContent = point.quest;
                } else {
                    document.getElementById('quest-block').style.display = 'none';
                }
            },

            showQuestHint: () => {
                const hints = ['–ò—â–∏—Ç–µ —á—Ç–æ-—Ç–æ –Ω–µ–æ–±—ã—á–Ω–æ–µ', '–ó–∞–º–µ—Ç—å—Ç–µ –¥–µ—Ç–∞–ª–∏', '–°–ø—Ä–æ—Å–∏—Ç–µ –º–µ—Å—Ç–Ω—ã—Ö', '–ü–æ–∏—â–∏—Ç–µ —Ä—è–¥–æ–º'];
                const hint = hints[Math.floor(Math.random() * hints.length)];
                const hintEl = document.getElementById('quest-hint');
                hintEl.style.display = 'block';
                hintEl.textContent = 'üí° ' + hint;
                app.log('quest_hint', { point_id: app.state.currentRoute.points[app.state.currentPointIndex].id });
            },

            navigate: () => {
                const point = app.state.currentRoute.points[app.state.currentPointIndex];
                app.log('navigate_click', { point_id: point.id });
                const [lat, lon] = point.coords;
                window.open(`https://maps.yandex.ru/?pt=${lon},${lat}&z=15&l=map`, '_blank');
            },

            checkInGeo: () => {
                app.log('step_checkin', { method: 'geo', success: true, distance: 0 });
                app.completePoint();
            },

            checkInQR: () => {
                app.log('step_checkin', { method: 'qr', success: true, distance: 0 });
                app.completePoint();
            },

            completePoint: () => {
                app.state.completedPoints.push(app.state.currentRoute.points[app.state.currentPointIndex].id);
                if (app.state.currentPointIndex < app.state.currentRoute.points.length - 1) {
                    app.state.currentPointIndex++;
                    app.renderStep();
                    app.toast('‚úÖ –ß–µ–∫-–∏–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω! –ò–¥—ë—Ç–µ –¥–∞–ª—å—à–µ?', 'success');
                } else {
                    app.log('route_finish', {
                        completed_points: app.state.completedPoints.length,
                        total_points: app.state.currentRoute.points.length,
                        mode: app.state.mode,
                    });
                    app.showScreen('finish');
                    app.renderFinish();
                }
            },

            skipPoint: () => {
                app.log('step_skip', { point_id: app.state.currentRoute.points[app.state.currentPointIndex].id });
                if (app.state.currentPointIndex < app.state.currentRoute.points.length - 1) {
                    app.state.currentPointIndex++;
                    app.renderStep();
                } else {
                    app.showScreen('finish');
                    app.renderFinish();
                }
            },

            renderFinish: () => {
                const route = app.state.currentRoute;
                document.getElementById('finish-completed').textContent = `${app.state.completedPoints.length}/${route.points.length}`;
                document.getElementById('finish-time').textContent = `${Math.round(route.totalTime * 0.8)} –º–∏–Ω`;
                document.getElementById('finish-distance').textContent = route.distance + ' –∫–º';

                const pointsHTML = route.points.map(p => `
                    <div class="point-item">
                        <div class="point-item__header">
                            <div class="point-item__title">${p.name}</div>
                        </div>
                        <div class="point-item__description">${p.description}</div>
                    </div>
                `).join('');
                document.getElementById('finish-points').innerHTML = pointsHTML;
            },

            createNew: () => {
                app.log('create_new_click');
                app.state.currentRoute = null;
                app.state.currentPointIndex = 0;
                app.state.completedPoints = [];
                app.map = null;
                app.showScreen('onboard');
            },

            showSaved: () => {
                app.showScreen('saved');
                app.renderSaved();
            },

            renderSaved: () => {
                const listEl = document.getElementById('saved-list');
                const emptyEl = document.getElementById('saved-empty');

                if (app.state.savedRoutes.length === 0) {
                    listEl.innerHTML = '';
                    emptyEl.style.display = 'flex';
                    return;
                }

                emptyEl.style.display = 'none';
                listEl.innerHTML = app.state.savedRoutes.map((route, i) => `
                    <div class="saved-item">
                        <div class="saved-item__info">
                            <div class="saved-item__title">${route.city}</div>
                            <div class="saved-item__meta">${route.totalTime} –º–∏–Ω ¬∑ ${route.points.length} —Ç–æ—á–µ–∫ ¬∑ ${route.mode === 'walk' ? '–ü—Ä–æ–≥—É–ª–∫–∞' : '–ö–≤–µ—Å—Ç'}</div>
                        </div>
                        <div class="saved-item__actions">
                            <button class="btn btn--small btn--secondary" onclick="app.openSavedRoute(${i})">–û—Ç–∫—Ä—ã—Ç—å</button>
                        </div>
                    </div>
                `).join('');
                app.log('saved_view');
            },

            openSavedRoute: (index) => {
                app.state.currentRoute = app.state.savedRoutes[index];
                app.log('saved_open', { route_id: app.state.currentRoute.id });
                app.map = null;
                app.showScreen('preview');
                app.renderPreview();
            },
        };

        document.addEventListener('DOMContentLoaded', () => {
            app.log('app_launch', { platform: 'telegram_web_app' });
        });
    </script>
</body>
</html>